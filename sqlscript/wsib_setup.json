{
	"name": "wsib_setup",
	"properties": {
		"content": {
			"query": "\n/*\nThis sample script shows how to create an external data source how to grant permissions.\n\nReferences:\n- Analyze data with a serverless SQL pool:\n    https://learn.microsoft.com/en-us/azure/synapse-analytics/get-started-analyze-sql-on-demand\n\n- CREATE DATABASE SCOPED CREDENTIAL (Transact-SQL):\n    https://learn.microsoft.com/en-us/sql/t-sql/statements/create-database-scoped-credential-transact-sql?view=sql-server-ver16\n\n- Control storage account access for serverless SQL pool in Azure Synapse Analytics:\n    https://learn.microsoft.com/en-us/azure/synapse-analytics/sql/develop-storage-files-storage-access-control?tabs=user-identity#examples\n\n- Use external tables with Synapse SQL:\n    https://learn.microsoft.com/en-us/azure/synapse-analytics/sql/develop-tables-external-tables?tabs=native#create-external-data-source\n\n- Store query results to storage using serverless SQL pool in Azure Synapse Analytics\n    https://learn.microsoft.com/en-us/azure/synapse-analytics/sql/create-external-table-as-select    \n\n- How to use OPENROWSET using serverless SQL pool\n    https://learn.microsoft.com/en-us/azure/synapse-analytics/sql/develop-openrowset\n*/\n\n--Create a database\nCREATE DATABASE wsib_db\n                COLLATE Latin1_General_100_BIN2_UTF8\nGO\n--Use database to create objects\nUSE wsib_db\nGO\n--Create login that will be used to connect to the database\nCREATE LOGIN wsib_db_login WITH PASSWORD = 'MyPass1234';    \nGO\nCREATE USER wsib_db_user FOR LOGIN wsib_db_login;\nGO\n\nGRANT ADMINISTER DATABASE BULK OPERATIONS TO wsib_db_user;\nGO\n\n-- Create a db master key if one does not already exist, using your own password.\nCREATE MASTER KEY ENCRYPTION BY PASSWORD='MyStrongPass1234';\n\n-- Create a database scoped credential.\nCREATE DATABASE SCOPED CREDENTIAL wsib_db_cred\nWITH IDENTITY = 'SHARED ACCESS SIGNATURE',\n--SECRET = '?sv=2021-06-08&ss=bfqt&srt=sco&sp=rwdlacupyx&se=2023-01-27T05:19:05Z&st=2022-10-18T20:19:05Z&spr=https&sig=DiEOs8fl6VWi0CUeAFJXbDNHy3cGb%2FPBOC3jEfn0dgs%3D';\nSECRET = '<My sas token>'\n\nGRANT REFERENCES ON DATABASE SCOPED CREDENTIAL::wsib_db_cred TO wsib_db_user\nGO\n\n--Create external data source\nCREATE EXTERNAL DATA SOURCE wsib_db_data_source\nWITH ( LOCATION = 'https://ezmylake.dfs.core.windows.net',\n        CREDENTIAL = wsib_db_cred\n    )\n;\n\nSELECT TOP 10 *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.cc_address.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nCREATE SCHEMA psaprod; --raw data\nCREATE SCHEMA prep; --transformed data\nCREATE EXTERNAL FILE FORMAT ParquetFormat WITH (  FORMAT_TYPE = PARQUET );\n\nCREATE EXTERNAL TABLE psaprod.test (ID int\n                                    ,PostalCode  varchar(20)\n                                    ,updatetime datetime\n                                    ,audit_batch_ts datetime) WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.cc_address.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n);\n\n--Create external table [psaprod].[cc_address]\ndrop external table psaprod.cc_address\nCREATE EXTERNAL TABLE psaprod.cc_address WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.cc_address.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.cc_address.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.cc_address TO wsib_db_user;\n\n--Create external table [psaprod].[cc_bodypart]\ndrop external table psaprod.cc_bodypart\nCREATE EXTERNAL TABLE psaprod.cc_bodypart WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.cc_bodypart.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.cc_bodypart.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.cc_bodypart TO wsib_db_user;\n\n--Create external table [psaprod].[cc_claim]\nDROP EXTERNAL TABLE psaprod.cc_claim\nCREATE EXTERNAL TABLE psaprod.cc_claim WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.cc_claim.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.cc_claim.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.cc_claim TO wsib_db_user;\n\n--Create external table [psaprod].[cc_contact]\ndrop external table psaprod.cc_contact\nCREATE EXTERNAL TABLE psaprod.cc_contact WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.cc_contact.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.cc_contact.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.cc_contact TO wsib_db_user;\n\n--Create external table [psaprod].[cc_exposure]\ndrop external table psaprod.cc_exposure\nCREATE EXTERNAL TABLE psaprod.cc_exposure WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.cc_exposure.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.cc_exposure.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.cc_exposure TO wsib_db_user;\n\n--Create external table [psaprod].[cc_incident]\ndrop external table psaprod.cc_incident\nCREATE EXTERNAL TABLE psaprod.cc_incident WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.cc_incident.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.cc_incident.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.cc_incident TO wsib_db_user;\n\n--Create external table [psaprod].[cc_policy]\ndrop external table psaprod.cc_policy\nCREATE EXTERNAL TABLE psaprod.cc_policy WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.cc_policy.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.cc_policy.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.cc_policy TO wsib_db_user;\n\n--Create external table [psaprod].[ccx_HealthCare_WC]\ndrop external table psaprod.ccx_HealthCare_WC\nCREATE EXTERNAL TABLE psaprod.ccx_HealthCare_WC WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.ccx_HealthCare_WC.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.ccx_HealthCare_WC.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.ccx_HealthCare_WC TO wsib_db_user;\n\n--Create external table [psaprod].[ccx_LossTimeRTW_WC]\ndrop external table psaprod.ccx_LossTimeRTW_WC\nCREATE EXTERNAL TABLE psaprod.ccx_LossTimeRTW_WC WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.ccx_LossTimeRTW_WC.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.ccx_LossTimeRTW_WC.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.ccx_LossTimeRTW_WC TO wsib_db_user;\n\n--Create external table [psaprod].[ccx_WSIB_Inc2Sequence]\ndrop external table psaprod.ccx_WSIB_Inc2Sequence\nCREATE EXTERNAL TABLE psaprod.ccx_WSIB_Inc2Sequence WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.ccx_WSIB_Inc2Sequence.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.ccx_WSIB_Inc2Sequence.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.ccx_WSIB_Inc2Sequence TO wsib_db_user;\n\n--Create external table [psaprod].[ccx_WSIB_ProjectID]\ndrop external table psaprod.ccx_WSIB_ProjectID\nCREATE EXTERNAL TABLE psaprod.ccx_WSIB_ProjectID WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.ccx_WSIB_ProjectID.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.ccx_WSIB_ProjectID.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.ccx_WSIB_ProjectID TO wsib_db_user;\n\n--Create external table [psaprod].[ccx_WSIB_StatCodeSystem]\ndrop external table psaprod.ccx_WSIB_StatCodeSystem\nCREATE EXTERNAL TABLE psaprod.ccx_WSIB_StatCodeSystem WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.ccx_WSIB_StatCodeSystem.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.ccx_WSIB_StatCodeSystem.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.ccx_WSIB_StatCodeSystem TO wsib_db_user;\n\n--Create external table [psaprod].[mastertypelist]\nDROP EXTERNAL TABLE psaprod.mastertypelist;\nCREATE EXTERNAL TABLE psaprod.mastertypelist WITH (\n        LOCATION = '/ez-filesystem/wsib_raw_tables/psaprod.mastertypelist.parquet',\n        DATA_SOURCE = [wsib_db_data_source],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/wsib_raw_sample_data/psaprod.mastertypelist.parquet/',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET'\n    ) AS [result];\n\n\nGRANT SELECT ON psaprod.mastertypelist TO wsib_db_user;\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "wsib_db",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}