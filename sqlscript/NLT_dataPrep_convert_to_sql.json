{
	"name": "NLT_dataPrep_convert_to_sql",
	"properties": {
		"content": {
			"query": "\nuse wsib_db;\n\n--dfMastertypelist_cc\n;with dfMastertypelist_cc(NAME,ID, DESCRIPTION,CCTL_NAME) as \n(SELECT a.NAME, a.ID, a.DESCRIPTION, a.CCTL_NAME\nFROM OPENROWSET(BULK '/ez-filesystem/wsib_raw_tables/psaprod.mastertypelist.parquet',\n        DATA_SOURCE = 'wsib_db_data_source',\n        FORMAT = 'PARQUET') as a\n--ORDER BY a.CCTL_NAME, a.ID\n),\n\n\n--dfClaim1_NLT\nwith dfClaim1_NLT(PublicID, ClaimNumber, accdt,Reg_dt,\n\tAssignedUserID, AssignedGroupID, Entitlementstate_WC,\n\tClaimType_WC, ClaimantDenormID, PolicyID, BranchLocationID_WC, \n\teAdj,PriorSimilarClaimYesNo_WC, PriorSimilarCond_WC, PriorSimilarSameArea_WC, \n\tClaim_ID, updatetime,rk) as \n(SELECT a.PublicID, a.ClaimNumber, cast(a.LossDate as date) as accdt, \n\tcast(a.WSIB_ClaimRegistrationDate as date) as Reg_dt,\n\ta.AssignedUserID, a.AssignedGroupID, a.Entitlementstate_WC,\n\ta.ClaimType_WC, a.ClaimantDenormID, a.PolicyID, a.BranchLocationID_WC, \n\t(case when (a.WSIB_iseAdjudicatedAllowed  = 1 or \n\ta.WSIB_iseAdjudicatedHIA  = 1) then 1 else 0 end) as eAdj,\n\ta.PriorSimilarClaimYesNo_WC, a.PriorSimilarCond_WC, a.PriorSimilarSameArea_WC, \n\ta.ID as Claim_ID, a.updatetime,\n\tRANK() OVER (PARTITION BY Claim_ID ORDER BY updatetime DESC) AS rk\nFROM (SELECT PublicID, ClaimNumber, LossDate, WSIB_ClaimRegistrationDate, AssignedUserID, AssignedGroupID, Entitlementstate_WC,\n\tClaimType_WC, ClaimantDenormID, PolicyID, BranchLocationID_WC, WSIB_iseAdjudicatedAllowed, WSIB_iseAdjudicatedHIA,\n\tPriorSimilarClaimYesNo_WC, PriorSimilarCond_WC, PriorSimilarSameArea_WC, ID, updatetime, WSIB_ClaimType\n\t\t\t\tFROM OPENROWSET(BULK 'https://ccstgp2hotcdsprod.dfs.core.windows.net/prd/PSA-CC/CC_CLAIM/Previous/*.parquet',FORMAT='PARQUET') as ACT\n\t\t\tunion all \n\t\t\tSELECT PublicID, ClaimNumber, LossDate, WSIB_ClaimRegistrationDate, AssignedUserID, AssignedGroupID, Entitlementstate_WC,\n\tClaimType_WC, ClaimantDenormID, PolicyID, BranchLocationID_WC, WSIB_iseAdjudicatedAllowed, WSIB_iseAdjudicatedHIA,\n\tPriorSimilarClaimYesNo_WC, PriorSimilarCond_WC, PriorSimilarSameArea_WC, ID, updatetime, WSIB_ClaimType\n\t\t\t\tFROM OPENROWSET(BULK 'https://ccstgp2hotcdsprod.dfs.core.windows.net/prd/PSA-CC/CC_CLAIM/*/*/*.parquet',FORMAT='PARQUET') as INA) as a\nWHERE a.LossDate between ? and ?\n\t\tand a.WSIB_ClaimRegistrationDate is not null\n\t\tand a.WSIB_ClaimType = 10002\n\t\tand a.ClaimType_WC = 10002\n--ORDER BY Claim_ID, a.updatetime desc\nand  rk = 1 AND a.Entitlementstate_WC == '10001'\n),\n\n--dfCOVID19\nSELECT distinct a.ID as Claim_ID\n\tFROM OPENROWSET(BULK 'https://ccstgp2hotcdsprod.dfs.core.windows.net/prd/PSA-CC/CC_CLAIM/Previous/*.parquet',FORMAT='PARQUET') as a\n       left join OPENROWSET(BULK 'https://ccstgp2hotcdsprod.dfs.core.windows.net/prd/PSA-CC/CCX_WSIB_STATCODESYSTEM/Previous/*.parquet',FORMAT='PARQUET') as k on k.claim = a.ID\n       left join OPENROWSET(BULK 'https://ccstgp2hotcdsprod.dfs.core.windows.net/prd/PSA-CC/CCX_WSIB_PROJECTID/Previous/*.parquet',FORMAT='PARQUET') as m on m.ID = k.WSIB_ProjectIDs\n\t   left join OPENROWSET(BULK 'https://ccstgp2hotcdsprod.dfs.core.windows.net/prd/PSA-CC/CC_INCIDENT/Previous/*.parquet',FORMAT='PARQUET') as inc on a.ID = inc.ClaimID\n\tWHERE a.LossDate between ? and ?\n\t\tand a.WSIB_ClaimRegistrationDate is not null\n\t\tand a.WSIB_ClaimType = 10002\n\t\tand (m.WSIB_ProjectCode='NCOV2019'\n\t\t\t\tor a.catastropheid=2901\n\t\t\t\tor inc.NatureOfAccident_WC = 10054)\n--ORDER BY Claim_ID\n;\n\n\n--dfDecision_dt_NLT\nSELECT a.ID as Claim_ID, cast(min(a.updatetime) as date) as Decision_dt\n\tFROM (SELECT ID, LossDate, updatetime, ClaimType_WC, Entitlementstate_WC, WSIB_ClaimRegistrationDate, WSIB_ClaimType\n\t\t\t\tFROM OPENROWSET(BULK 'https://ccstgp2hotcdsprod.dfs.core.windows.net/prd/PSA-CC/CC_CLAIM/Previous/*.parquet',FORMAT='PARQUET') as ACT\n\t\t\tunion all \n\t\t\tSELECT ID, LossDate, updatetime, ClaimType_WC, Entitlementstate_WC, WSIB_ClaimRegistrationDate, WSIB_ClaimType\n\t\t\t\tFROM OPENROWSET(BULK 'https://ccstgp2hotcdsprod.dfs.core.windows.net/prd/PSA-CC/CC_CLAIM/*/*/*.parquet',FORMAT='PARQUET') as INA) as a\n\tWHERE a.ClaimType_WC = 10002 and a.Entitlementstate_WC = 10001\n\t\tand a.LossDate between ? and ?\n\t\tand a.WSIB_ClaimRegistrationDate is not null\n\t\tand a.WSIB_ClaimType = 10002\n\tGROUP BY a.ID\n\tORDER BY a.ID;\n\n\n--dfClaim1_NLT_2 = pd.merge(dfClaim1_NLT, dfDecision_dt_NLT, how=\"left\", on=[\"Claim_ID\"])\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "wsib_db",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}