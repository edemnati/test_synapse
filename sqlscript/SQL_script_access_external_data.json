{
	"name": "SQL_script_access_external_data",
	"properties": {
		"content": {
			"query": "\n/*\nThis sample script shows how to create an external data source how to grant permissions.\n\nReferences:\n- Analyze data with a serverless SQL pool:\n    https://learn.microsoft.com/en-us/azure/synapse-analytics/get-started-analyze-sql-on-demand\n\n- CREATE DATABASE SCOPED CREDENTIAL (Transact-SQL):\n    https://learn.microsoft.com/en-us/sql/t-sql/statements/create-database-scoped-credential-transact-sql?view=sql-server-ver16\n\n- Control storage account access for serverless SQL pool in Azure Synapse Analytics:\n    https://learn.microsoft.com/en-us/azure/synapse-analytics/sql/develop-storage-files-storage-access-control?tabs=user-identity#examples\n\n- Use external tables with Synapse SQL:\n    https://learn.microsoft.com/en-us/azure/synapse-analytics/sql/develop-tables-external-tables?tabs=native#create-external-data-source\n\n- Store query results to storage using serverless SQL pool in Azure Synapse Analytics\n    https://learn.microsoft.com/en-us/azure/synapse-analytics/sql/create-external-table-as-select    \n\n- How to use OPENROWSET using serverless SQL pool\n    https://learn.microsoft.com/en-us/azure/synapse-analytics/sql/develop-openrowset\n*/\n\n--Create a database\nCREATE DATABASE DB_test\n                COLLATE Latin1_General_100_BIN2_UTF8\nGO\n--Use database to create objects\nUSE db_test\nGO\n--Create login that will be used to connect to the database\nCREATE LOGIN db_test_login WITH PASSWORD = 'MyPass1234';    \nGO\nCREATE USER db_test_user FOR LOGIN db_test_login;\nGO\nGRANT ADMINISTER DATABASE BULK OPERATIONS TO db_test_user;\nGO\n\n-- Create a db master key if one does not already exist, using your own password.\nCREATE MASTER KEY ENCRYPTION BY PASSWORD='MyStrongPass1234';\n\n-- Create a database scoped credential.\nCREATE DATABASE SCOPED CREDENTIAL MyTestCred_27jan\nWITH IDENTITY = 'SHARED ACCESS SIGNATURE',\nSECRET = '?sv=2021-06-08&ss=bfqt&srt=sco&sp=rwdlacupyx&se=2023-01-27T05:19:05Z&st=2022-10-18T20:19:05Z&spr=https&sig=DiEOs8fl6VWi0CUeAFJXbDNHy3cGb%2FPBOC3jEfn0dgs%3D';\n\nSECRET = '<My sas token>'\n\nGRANT REFERENCES ON DATABASE SCOPED CREDENTIAL::MyTestCred_27jan TO db_test_user\nGO\n\n--Create external data source\nCREATE EXTERNAL DATA SOURCE test_data_source_27jan\nWITH ( LOCATION = 'https://ezmylake.dfs.core.windows.net',\n        CREDENTIAL = MyTestCred_27jan\n    )\n\n    \n\n--Try to select data from data source\nCREATE EXTERNAL DATA SOURCE test_ds2\nWITH ( LOCATION = 'https://ezmylake.dfs.core.windows.net')\n\nSELECT TOP 10 *\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/NYCTripSmall.parquet',\n        DATA_SOURCE = 'test_data_source_dec30',\n        FORMAT = 'PARQUET'\n    ) AS [result]\n\n\n--Create external table\nCREATE EXTERNAL FILE FORMAT ParquetFormat WITH (  FORMAT_TYPE = PARQUET );\ndrop EXTERNAL TABLE NYCTripSmall;\nCREATE EXTERNAL TABLE NYCTripSmall2\n(\n    [DateID] int,\n     [MedallionID] int,\n     [HackneyLicenseID] int,\n     [PickupTimeID] int,\n     [DropoffTimeID] int,\n     [PickupGeographyID] int,\n     [DropoffGeographyID] int,\n     [PickupLatitude] float,\n     [PickupLongitude] float,\n     [PickupLatLong] nvarchar(4000),\n     [DropoffLatitude] float,\n     [DropoffLongitude] float,\n     [DropoffLatLong] nvarchar(4000),\n     [PassengerCount] int,\n     [TripDurationSeconds] int,\n     [TripDistanceMiles] float,\n     [PaymentType] nvarchar(4000),\n     [FareAmount] numeric(19,4),\n     [SurchargeAmount] numeric(19,4),\n     [TaxAmount] numeric(19,4),\n     [TipAmount] numeric(19,4),\n     [TollsAmount] numeric(19,4),\n     [TotalAmount] numeric(19,4)\n)\nWITH (\n    LOCATION = '/ez-filesystem/NYCTripSmall.parquet',\n    DATA_SOURCE = test_data_source_dec30,\n    FILE_FORMAT = ParquetFormat\n);\n\n--Grant permission to external table\nGRANT SELECT ON dbo.NYCTripSmall2 TO db_test_user;\n\n\nselect top(10) * from DB_test.dbo.NYCTripSmall\n\n\n\n--Save query result to external table\nDROP EXTERNAL TABLE [dbo].[test_save_table]\nCREATE EXTERNAL TABLE [dbo].[test_save_table6] WITH (\n        LOCATION = '/ez-filesystem/transformed_data6/test.parquet',\n        --DATA_SOURCE = [test_data_source_27jan],\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  PaymentType, \n        sum(PassengerCount) as sum_passengerCount,\n        sum(FareAmount) as sum_FareAmount\nFROM\n    OPENROWSET(\n        BULK '/ez-filesystem/NYCTripSmall.parquet',\n        DATA_SOURCE = 'test_data_source_27jan',\n        FORMAT = 'PARQUET'\n    ) AS [result]\nGROUP BY PaymentType;\n\n\nGRANT SELECT ON dbo.test_save_table6 TO db_test_user;\n\n\n\nCREATE EXTERNAL TABLE [dbo].[test_save_table_nods] WITH (\n        LOCATION = '/ez-filesystem/transformed_data_nods/test.parquet',\n        DATA_SOURCE = 'https://ezmylake.dfs.core.windows.net',\n        FILE_FORMAT = ParquetFormat\n) AS\nSELECT  PaymentType, \n        sum(PassengerCount) as sum_passengerCount,\n        sum(FareAmount) as sum_FareAmount\nFROM\n    OPENROWSET(\n        BULK 'https://ezmylake.dfs.core.windows.net/ez-filesystem/NYCTripSmall.parquet',\n        FORMAT = 'PARQUET'\n    ) AS [result]\nGROUP BY PaymentType;\n\n\n--Test change user\nSELECT CURRENT_USER, USER_NAME() \nGO  \nEXECUTE AS USER = 'db_test_user';  \nGO  \nSELECT CURRENT_USER;  \nGO  \nREVERT;  \nGO  \nSELECT CURRENT_USER;  \nGO  ",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "DB_test",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}